// BAKOELAPTOP - Entity Relationship Diagram
// Marketplace Jual Beli Laptop Bekas
// Firebase Firestore Database Structure
// Created: November 13, 2025

// ============================================================================
// TABLE: USERS
// ============================================================================
Table users {
  uid varchar [primary key, note: 'Firebase Auth UID']
  email varchar [not null, unique, note: 'User email address']
  fullname varchar [not null, note: 'User full name']
  username varchar [not null, note: 'Unique username']
  phone varchar [note: 'Phone number (10-13 digits)']
  role varchar [not null, default: 'user', note: 'user | admin']
  createdAt timestamp [not null, note: 'Account creation time']
  updatedAt timestamp [not null, note: 'Last update time']
  
  Indexes {
    email [unique]
    uid [unique]
  }
}

// ============================================================================
// TABLE: PRODUCTS
// ============================================================================
Table products {
  id varchar [primary key, note: 'Auto-generated product ID']
  sellerId varchar [not null, note: 'Foreign key to users.uid']
  sellerEmail varchar [not null, note: 'Seller email for reference']
  name varchar [not null, note: 'Product name']
  price decimal [not null, note: 'Price in IDR (must be > 0)']
  description text [note: 'Product description']
  category varchar [not null, note: 'gaming | bisnis | multimedia | etc']
  condition varchar [not null, note: 'baru | bekas | refurbished']
  stock integer [not null, default: 1, note: 'Available quantity (>= 0)']
  imageURL text [note: 'Base64 encoded image']
  status varchar [not null, default: 'pending', note: 'pending | approved | rejected']
  sold boolean [not null, default: false, note: 'Mark as sold']
  createdAt timestamp [not null, note: 'Product submission time']
  updatedAt timestamp [not null, note: 'Last update time']
  
  Indexes {
    (status, createdAt) [name: 'idx_status_created', note: 'Composite index for approved products sorting']
    sellerId
  }
}

// ============================================================================
// TABLE: CARTS
// ============================================================================
Table carts {
  userId varchar [primary key, note: 'Foreign key to users.uid, one cart per user']
  items json [note: 'Array of cart items (embedded)']
  updatedAt timestamp [not null, note: 'Last cart update time']
  
  Note: 'Cart items are stored as embedded array for performance'
}

// ============================================================================
// TABLE: CART_ITEMS (Embedded in carts.items)
// ============================================================================
// Note: This is not a separate collection in Firestore
// It's embedded as an array inside the carts collection
// Schema for reference only:
//
// cart_items {
//   productId: varchar (reference to products.id)
//   name: varchar
//   price: decimal
//   imageURL: text (base64)
//   quantity: integer
//   addedAt: timestamp
// }

// ============================================================================
// RELATIONSHIPS
// ============================================================================

// One user can sell many products (1:N)
Ref: products.sellerId > users.uid [note: 'Seller relationship']

// One user has one cart (1:1)
Ref: carts.userId - users.uid [note: 'User cart relationship']

// Products are referenced in cart items (1:N - denormalized)
// Note: This is a logical reference, not enforced by Firebase
// Cart items store a copy of product data for performance

// ============================================================================
// BUSINESS RULES & CONSTRAINTS
// ============================================================================

// USERS TABLE:
// - role: Only 'user' or 'admin' allowed
// - email: Must be unique and valid format
// - Default role is 'user'

// PRODUCTS TABLE:
// - status: Only 'pending', 'approved', or 'rejected' allowed
// - price: Must be greater than 0
// - stock: Must be >= 0
// - sold: Default is false
// - Product visibility rules:
//   * pending: Only visible to seller and admin
//   * approved + sold=false: Visible on Buy page
//   * approved + sold=true: Not visible
//   * rejected: Not visible

// CARTS TABLE:
// - One cart per user (1:1 relationship)
// - Cart is created automatically when user adds first item
// - Cart persists after logout/login
// - Items array contains denormalized product data

// ============================================================================
// INDEXES
// ============================================================================

// 1. users.email - Automatic (Firebase Auth)
// 2. users.uid - Primary key
// 3. products.id - Primary key
// 4. products.(status, createdAt) - Composite index for query optimization
// 5. products.sellerId - For querying seller's products
// 6. carts.userId - Primary key

// ============================================================================
// WORKFLOW: PRODUCT APPROVAL
// ============================================================================

// 1. Seller submits product → status = 'pending'
// 2. Admin reviews in admin dashboard
// 3. Admin approves → status = 'approved' → visible on Buy page
// 4. Admin rejects → status = 'rejected' → not visible
// 5. Admin marks as sold → sold = true → not visible
// 6. Admin can delete product → removed from database

// ============================================================================
// WORKFLOW: SHOPPING CART
// ============================================================================

// 1. User clicks "Add to Cart" on Buy page
// 2. System checks if cart exists for user
// 3. If no cart, create new cart document
// 4. Add product to cart.items array (with productId, name, price, etc)
// 5. User can update quantity or remove items
// 6. Cart syncs in real-time across devices
// 7. Cart persists after logout (tied to userId)

// ============================================================================
// NOTES
// ============================================================================

// Firebase Firestore Implementation:
// - Collections: users, products, carts
// - Subcollections: None (cart items embedded as array)
// - Real-time listeners: onSnapshot for live updates
// - Security: Firebase Auth + Firestore Security Rules
// - Storage: Base64 for images (embedded in documents)

// Performance Optimizations:
// - Composite index for approved products query
// - Denormalized cart data (avoid joins)
// - Client-side filtering for sold products
// - Pagination ready (can add limit/offset)

// Future Enhancements:
// - Add orders collection for checkout
// - Add reviews collection for product ratings
// - Add notifications collection
// - Move images to Firebase Storage (currently base64)
